<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognito Google OAuth í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #log-area { margin-top: 20px; text-align: left; background: #f4f4f4; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
        .warning { color: red; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>AWS Cognito Google OAuth í…ŒìŠ¤íŠ¸</h2>
    <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ Cognito Hosted UIë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
    
    <button id="loginButton">Google ë¡œê·¸ì¸ ì‹œì‘</button>
    
    <div class="warning">
        <p><strong>ğŸš¨ ì£¼ì˜:</strong> ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ëŒì•„ê°€ë ¤ë©´ Cognito ì•± í´ë¼ì´ì–¸íŠ¸ ì„¤ì •ì— ë“±ë¡ëœ **ì½œë°± URL**ê³¼ ì´ í˜ì´ì§€ì˜ ì£¼ì†Œê°€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
        <p id="currentUrl"></p>
        <p>ë¡œê·¸ì¸ í›„, ì´ í˜ì´ì§€ë¡œ ëŒì•„ì˜¤ë©´ ì•„ë˜ ë¡œê·¸ ì˜ì—­ì— URL íŒŒë¼ë¯¸í„°ê°€ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
    </div>

    <h3>ë¡œê·¸ ì˜ì—­</h3>
    <div id="log-area">ì¸ì¦ ì½”ë“œ (code) ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    // ----------------------------------------------------------------
    // ğŸ’¡ 1. ì—¬ê¸°ì— Cognito ë° ì•± í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš” 
    // ----------------------------------------------------------------
    const COGNITO_DOMAIN = "https://ap-northeast-2ogyeziy8w.auth.ap-northeast-2.amazoncognito.com"; // ì˜ˆ: https://your-domain.auth.region.amazoncognito.com
    const CLIENT_ID = "159l7p0a7ell5c7srlf3v4tqgf"; // Cognito ì•± í´ë¼ì´ì–¸íŠ¸ ID>"; 
    const REDIRECT_URI = "http://localhost:29000/test_cognito_google_oauth.html"; // ì‹¤ì œ í…ŒìŠ¤íŠ¸í•  ì´ HTML íŒŒì¼ì˜ ì£¼ì†Œì—¬ì•¼ í•©ë‹ˆë‹¤!
    const SCOPE = "openid email profile";
    const RESPONSE_TYPE = "code"; // OAuth Authorization Code Grant ë°©ì‹
    
    // ----------------------------------------------------------------
    // ğŸ’¡ 2. ë¡œì§ êµ¬í˜„ 
    // ----------------------------------------------------------------
    
    // í˜„ì¬ URL í‘œì‹œ ë° ì½œë°± íŒŒë¼ë¯¸í„° í™•ì¸
    const currentUrlDisplay = document.getElementById('currentUrl');
    currentUrlDisplay.textContent = `í˜„ì¬ URL (ë“±ë¡ëœ ì½œë°± URLê³¼ ì¼ì¹˜í•´ì•¼ í•¨): ${window.location.href}`;

    function log(message) {
        document.getElementById('log-area').innerHTML = message;
    }

    // A. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬: Hosted UIë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
    document.getElementById('loginButton').addEventListener('click', () => {
        // CSRF ë°©ì§€ë¥¼ ìœ„í•œ state ê°’ ìƒì„± (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œì¥ë¨)
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem('oauth_state', state);

        const authUrl = 
            `${COGNITO_DOMAIN}/oauth2/authorize?` +
            `response_type=${RESPONSE_TYPE}&` +
            `client_id=${CLIENT_ID}&` +
            `redirect_uri=${REDIRECT_URI}&` +
            `scope=${SCOPE}&` +
            `state=${state}`;
            
        window.location.href = authUrl;
    });

    // B. í˜ì´ì§€ ë¡œë“œ ì‹œ, ì½œë°± URLì—ì„œ 'code' íŒŒë¼ë¯¸í„° í™•ì¸
    function checkCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        const error = urlParams.get('error');
        const returnedState = urlParams.get('state');
        const originalState = localStorage.getItem('oauth_state');

        if (error) {
            log(`âŒ ì¸ì¦ ì‹¤íŒ¨ ì˜¤ë¥˜: ${error}`);
            return;
        }

        if (authCode) {
            // State ê°’ ê²€ì¦ (CSRF ë°©ì§€)
            if (returnedState !== originalState) {
                log(`ğŸš¨ ìƒíƒœ ê²€ì¦ ì‹¤íŒ¨! CSRF ê³µê²© ê°€ëŠ¥ì„±. ë°˜í™˜ëœ State: ${returnedState}`);
                localStorage.removeItem('oauth_state');
                return;
            }
            localStorage.removeItem('oauth_state');

            // ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ë°›ìŒ
            log(`âœ… Google OAuth ì¸ì¦ ì„±ê³µ! \n\n**ë‹¤ìŒ ë‹¨ê³„: ì´ ì¸ì¦ ì½”ë“œ(code)ë¥¼ ë°±ì—”ë“œì— ì „ë‹¬í•˜ì—¬ Access Tokenì„ êµí™˜í•´ì•¼ í•©ë‹ˆë‹¤.**\n\nìˆ˜ì‹ ëœ ì¸ì¦ ì½”ë“œ (Code):\n${authCode}\n\nì „ì²´ URL íŒŒë¼ë¯¸í„°:\n${window.location.search}`);
        } else if (window.location.search) {
            // ê¸°íƒ€ ë‹¤ë¥¸ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ê²½ìš°
            log(`â„¹ï¸ URLì— íŒŒë¼ë¯¸í„°ê°€ ìˆì§€ë§Œ 'code'ê°€ ì—†ìŠµë‹ˆë‹¤. (ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ)`);
        }
    }

    checkCallback();

</script>

</body>
</html>